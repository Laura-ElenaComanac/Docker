{"ast":null,"code":"var _jsxFileName = \"/Users/laura-elena.olaru/Downloads/Microservices/my-ionic-app/src/todo/ItemProvider.tsx\";\nimport React, { useCallback, useContext, useEffect, useReducer } from 'react';\nimport { getLogger } from '../core';\nimport { createItem, getItems, newWebSocket, updateItem } from './itemApi';\nimport { AuthContext } from '../auth';\nconst log = getLogger('ItemProvider');\nconst initialState = {\n  fetching: false,\n  saving: false\n};\nconst FETCH_ITEMS_STARTED = 'FETCH_ITEMS_STARTED';\nconst FETCH_ITEMS_SUCCEEDED = 'FETCH_ITEMS_SUCCEEDED';\nconst FETCH_ITEMS_FAILED = 'FETCH_ITEMS_FAILED';\nconst SAVE_ITEM_STARTED = 'SAVE_ITEM_STARTED';\nconst SAVE_ITEM_SUCCEEDED = 'SAVE_ITEM_SUCCEEDED';\nconst SAVE_ITEM_FAILED = 'SAVE_ITEM_FAILED';\n\nconst reducer = (state, {\n  type,\n  payload\n}) => {\n  switch (type) {\n    case FETCH_ITEMS_STARTED:\n      return { ...state,\n        fetching: true,\n        fetchingError: null\n      };\n\n    case FETCH_ITEMS_SUCCEEDED:\n      return { ...state,\n        items: payload.items,\n        fetching: false\n      };\n\n    case FETCH_ITEMS_FAILED:\n      return { ...state,\n        fetchingError: payload.error,\n        fetching: false\n      };\n\n    case SAVE_ITEM_STARTED:\n      return { ...state,\n        savingError: null,\n        saving: true\n      };\n\n    case SAVE_ITEM_SUCCEEDED:\n      const items = [...(state.items || [])];\n      const item = payload.item;\n      const index = items.findIndex(it => it._id === item._id);\n\n      if (index === -1) {\n        items.splice(0, 0, item);\n      } else {\n        items[index] = item;\n      }\n\n      return { ...state,\n        items,\n        saving: false\n      };\n\n    case SAVE_ITEM_FAILED:\n      return { ...state,\n        savingError: payload.error,\n        saving: false\n      };\n\n    default:\n      return state;\n  }\n};\n\nexport const ItemContext = React.createContext(initialState);\nexport const ItemProvider = ({\n  children\n}) => {\n  const {\n    token\n  } = useContext(AuthContext);\n  const [state, dispatch] = useReducer(reducer, initialState);\n  const {\n    items,\n    fetching,\n    fetchingError,\n    saving,\n    savingError\n  } = state;\n  useEffect(getItemsEffect, [token]);\n  useEffect(wsEffect, [token]);\n  const saveItem = useCallback(saveItemCallback, [token]);\n  const value = {\n    items,\n    fetching,\n    fetchingError,\n    saving,\n    savingError,\n    saveItem\n  };\n  log('returns');\n  return /*#__PURE__*/React.createElement(ItemContext.Provider, {\n    value: value,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 82,\n      columnNumber: 5\n    }\n  }, children);\n\n  function getItemsEffect() {\n    let canceled = false;\n    fetchItems();\n    return () => {\n      canceled = true;\n    };\n\n    async function fetchItems() {\n      if (!(token === null || token === void 0 ? void 0 : token.trim())) {\n        return;\n      }\n\n      try {\n        log('fetchItems started');\n        dispatch({\n          type: FETCH_ITEMS_STARTED\n        });\n        const items = await getItems(token);\n        log('fetchItems succeeded');\n\n        if (!canceled) {\n          dispatch({\n            type: FETCH_ITEMS_SUCCEEDED,\n            payload: {\n              items\n            }\n          });\n        }\n      } catch (error) {\n        log('fetchItems failed');\n        dispatch({\n          type: FETCH_ITEMS_FAILED,\n          payload: {\n            error\n          }\n        });\n      }\n    }\n  }\n\n  async function saveItemCallback(item) {\n    try {\n      log('saveItem started');\n      dispatch({\n        type: SAVE_ITEM_STARTED\n      });\n      const savedItem = await (item._id ? updateItem(token, item) : createItem(token, item));\n      log('saveItem succeeded');\n      dispatch({\n        type: SAVE_ITEM_SUCCEEDED,\n        payload: {\n          item: savedItem\n        }\n      });\n    } catch (error) {\n      log('saveItem failed');\n      dispatch({\n        type: SAVE_ITEM_FAILED,\n        payload: {\n          error\n        }\n      });\n    }\n  }\n\n  function wsEffect() {\n    let canceled = false;\n    log('wsEffect - connecting');\n    let closeWebSocket;\n\n    if (token === null || token === void 0 ? void 0 : token.trim()) {\n      closeWebSocket = newWebSocket(token, message => {\n        if (canceled) {\n          return;\n        }\n\n        const {\n          type,\n          payload: item\n        } = message;\n        log(`ws message, item ${type}`);\n\n        if (type === 'created' || type === 'updated') {\n          dispatch({\n            type: SAVE_ITEM_SUCCEEDED,\n            payload: {\n              item\n            }\n          });\n        }\n      });\n    }\n\n    return () => {\n      var _closeWebSocket;\n\n      log('wsEffect - disconnecting');\n      canceled = true;\n      (_closeWebSocket = closeWebSocket) === null || _closeWebSocket === void 0 ? void 0 : _closeWebSocket();\n    };\n  }\n};","map":{"version":3,"sources":["/Users/laura-elena.olaru/Downloads/Microservices/my-ionic-app/src/todo/ItemProvider.tsx"],"names":["React","useCallback","useContext","useEffect","useReducer","getLogger","createItem","getItems","newWebSocket","updateItem","AuthContext","log","initialState","fetching","saving","FETCH_ITEMS_STARTED","FETCH_ITEMS_SUCCEEDED","FETCH_ITEMS_FAILED","SAVE_ITEM_STARTED","SAVE_ITEM_SUCCEEDED","SAVE_ITEM_FAILED","reducer","state","type","payload","fetchingError","items","error","savingError","item","index","findIndex","it","_id","splice","ItemContext","createContext","ItemProvider","children","token","dispatch","getItemsEffect","wsEffect","saveItem","saveItemCallback","value","canceled","fetchItems","trim","savedItem","closeWebSocket","message"],"mappings":"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","sourcesContent":["import React, { useCallback, useContext, useEffect, useReducer } from 'react';\nimport PropTypes from 'prop-types';\nimport { getLogger } from '../core';\nimport { ItemProps } from './ItemProps';\nimport { createItem, getItems, newWebSocket, updateItem } from './itemApi';\nimport { AuthContext } from '../auth';\n\nconst log = getLogger('ItemProvider');\n\ntype SaveItemFn = (item: ItemProps) => Promise<any>;\n\nexport interface ItemsState {\n  items?: ItemProps[],\n  fetching: boolean,\n  fetchingError?: Error | null,\n  saving: boolean,\n  savingError?: Error | null,\n  saveItem?: SaveItemFn,\n}\n\ninterface ActionProps {\n  type: string,\n  payload?: any,\n}\n\nconst initialState: ItemsState = {\n  fetching: false,\n  saving: false,\n};\n\nconst FETCH_ITEMS_STARTED = 'FETCH_ITEMS_STARTED';\nconst FETCH_ITEMS_SUCCEEDED = 'FETCH_ITEMS_SUCCEEDED';\nconst FETCH_ITEMS_FAILED = 'FETCH_ITEMS_FAILED';\nconst SAVE_ITEM_STARTED = 'SAVE_ITEM_STARTED';\nconst SAVE_ITEM_SUCCEEDED = 'SAVE_ITEM_SUCCEEDED';\nconst SAVE_ITEM_FAILED = 'SAVE_ITEM_FAILED';\n\nconst reducer: (state: ItemsState, action: ActionProps) => ItemsState =\n  (state, { type, payload }) => {\n    switch (type) {\n      case FETCH_ITEMS_STARTED:\n        return { ...state, fetching: true, fetchingError: null };\n      case FETCH_ITEMS_SUCCEEDED:\n        return { ...state, items: payload.items, fetching: false };\n      case FETCH_ITEMS_FAILED:\n        return { ...state, fetchingError: payload.error, fetching: false };\n      case SAVE_ITEM_STARTED:\n        return { ...state, savingError: null, saving: true };\n      case SAVE_ITEM_SUCCEEDED:\n        const items = [...(state.items || [])];\n        const item = payload.item;\n        const index = items.findIndex(it => it._id === item._id);\n        if (index === -1) {\n          items.splice(0, 0, item);\n        } else {\n          items[index] = item;\n        }\n        return { ...state, items, saving: false };\n      case SAVE_ITEM_FAILED:\n        return { ...state, savingError: payload.error, saving: false };\n      default:\n        return state;\n    }\n  };\n\nexport const ItemContext = React.createContext<ItemsState>(initialState);\n\ninterface ItemProviderProps {\n  children: PropTypes.ReactNodeLike,\n}\n\nexport const ItemProvider: React.FC<ItemProviderProps> = ({ children }) => {\n  const { token } = useContext(AuthContext);\n  const [state, dispatch] = useReducer(reducer, initialState);\n  const { items, fetching, fetchingError, saving, savingError } = state;\n  useEffect(getItemsEffect, [token]);\n  useEffect(wsEffect, [token]);\n  const saveItem = useCallback<SaveItemFn>(saveItemCallback, [token]);\n  const value = { items, fetching, fetchingError, saving, savingError, saveItem };\n  log('returns');\n  return (\n    <ItemContext.Provider value={value}>\n      {children}\n    </ItemContext.Provider>\n  );\n\n  function getItemsEffect() {\n    let canceled = false;\n    fetchItems();\n    return () => {\n      canceled = true;\n    }\n\n    async function fetchItems() {\n      if (!token?.trim()) {\n        return;\n      }\n      try {\n        log('fetchItems started');\n        dispatch({ type: FETCH_ITEMS_STARTED });\n        const items = await getItems(token);\n        log('fetchItems succeeded');\n        if (!canceled) {\n          dispatch({ type: FETCH_ITEMS_SUCCEEDED, payload: { items } });\n        }\n      } catch (error) {\n        log('fetchItems failed');\n        dispatch({ type: FETCH_ITEMS_FAILED, payload: { error } });\n      }\n    }\n  }\n\n  async function saveItemCallback(item: ItemProps) {\n    try {\n      log('saveItem started');\n      dispatch({ type: SAVE_ITEM_STARTED });\n      const savedItem = await (item._id ? updateItem(token, item) : createItem(token, item));\n      log('saveItem succeeded');\n      dispatch({ type: SAVE_ITEM_SUCCEEDED, payload: { item: savedItem } });\n    } catch (error) {\n      log('saveItem failed');\n      dispatch({ type: SAVE_ITEM_FAILED, payload: { error } });\n    }\n  }\n\n  function wsEffect() {\n    let canceled = false;\n    log('wsEffect - connecting');\n    let closeWebSocket: () => void;\n    if (token?.trim()) {\n      closeWebSocket = newWebSocket(token, message => {\n        if (canceled) {\n          return;\n        }\n        const { type, payload: item } = message;\n        log(`ws message, item ${type}`);\n        if (type === 'created' || type === 'updated') {\n          dispatch({ type: SAVE_ITEM_SUCCEEDED, payload: { item } });\n        }\n      });\n    }\n    return () => {\n      log('wsEffect - disconnecting');\n      canceled = true;\n      closeWebSocket?.();\n    }\n  }\n};\n"]},"metadata":{},"sourceType":"module"}