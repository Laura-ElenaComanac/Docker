{"ast":null,"code":"import _regeneratorRuntime from\"/Users/laura-elena.olaru/Downloads/FinalDocker/my-ionic-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/laura-elena.olaru/Downloads/FinalDocker/my-ionic-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/laura-elena.olaru/Downloads/FinalDocker/my-ionic-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _toConsumableArray from\"/Users/laura-elena.olaru/Downloads/FinalDocker/my-ionic-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _objectSpread from\"/Users/laura-elena.olaru/Downloads/FinalDocker/my-ionic-app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import React,{useCallback,useContext,useEffect,useReducer}from'react';import{getLogger}from'../core';import{createItem,getItems,newWebSocket,updateItem}from'./itemApi';import{AuthContext}from'../auth';var log=getLogger('ItemProvider');var initialState={fetching:false,saving:false};var FETCH_ITEMS_STARTED='FETCH_ITEMS_STARTED';var FETCH_ITEMS_SUCCEEDED='FETCH_ITEMS_SUCCEEDED';var FETCH_ITEMS_FAILED='FETCH_ITEMS_FAILED';var SAVE_ITEM_STARTED='SAVE_ITEM_STARTED';var SAVE_ITEM_SUCCEEDED='SAVE_ITEM_SUCCEEDED';var SAVE_ITEM_FAILED='SAVE_ITEM_FAILED';var reducer=function reducer(state,_ref){var type=_ref.type,payload=_ref.payload;switch(type){case FETCH_ITEMS_STARTED:return _objectSpread(_objectSpread({},state),{},{fetching:true,fetchingError:null});case FETCH_ITEMS_SUCCEEDED:return _objectSpread(_objectSpread({},state),{},{items:payload.items,fetching:false});case FETCH_ITEMS_FAILED:return _objectSpread(_objectSpread({},state),{},{fetchingError:payload.error,fetching:false});case SAVE_ITEM_STARTED:return _objectSpread(_objectSpread({},state),{},{savingError:null,saving:true});case SAVE_ITEM_SUCCEEDED:var items=_toConsumableArray(state.items||[]);var _item=payload.item;var index=items.findIndex(function(it){return it._id===_item._id;});if(index===-1){items.splice(0,0,_item);}else{items[index]=_item;}return _objectSpread(_objectSpread({},state),{},{items:items,saving:false});case SAVE_ITEM_FAILED:return _objectSpread(_objectSpread({},state),{},{savingError:payload.error,saving:false});default:return state;}};export var ItemContext=React.createContext(initialState);export var ItemProvider=function ItemProvider(_ref2){var children=_ref2.children;var _useContext=useContext(AuthContext),token=_useContext.token;var _useReducer=useReducer(reducer,initialState),_useReducer2=_slicedToArray(_useReducer,2),state=_useReducer2[0],dispatch=_useReducer2[1];var items=state.items,fetching=state.fetching,fetchingError=state.fetchingError,saving=state.saving,savingError=state.savingError;useEffect(getItemsEffect,[token]);useEffect(wsEffect,[token]);var saveItem=useCallback(saveItemCallback,[token]);var value={items:items,fetching:fetching,fetchingError:fetchingError,saving:saving,savingError:savingError,saveItem:saveItem};log('returns');return/*#__PURE__*/React.createElement(ItemContext.Provider,{value:value},children);function getItemsEffect(){var canceled=false;fetchItems();return function(){canceled=true;};function fetchItems(){return _fetchItems.apply(this,arguments);}function _fetchItems(){_fetchItems=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _items;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(token===null||token===void 0?void 0:token.trim()){_context.next=2;break;}return _context.abrupt(\"return\");case 2:_context.prev=2;log('fetchItems started');dispatch({type:FETCH_ITEMS_STARTED});_context.next=7;return getItems(token);case 7:_items=_context.sent;log('fetchItems succeeded');if(!canceled){dispatch({type:FETCH_ITEMS_SUCCEEDED,payload:{items:_items}});}_context.next=16;break;case 12:_context.prev=12;_context.t0=_context[\"catch\"](2);log('fetchItems failed');dispatch({type:FETCH_ITEMS_FAILED,payload:{error:_context.t0}});case 16:case\"end\":return _context.stop();}}},_callee,null,[[2,12]]);}));return _fetchItems.apply(this,arguments);}}function saveItemCallback(_x){return _saveItemCallback.apply(this,arguments);}function _saveItemCallback(){_saveItemCallback=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(item){var savedItem;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;log('saveItem started');dispatch({type:SAVE_ITEM_STARTED});_context2.next=5;return item._id?updateItem(token,item):createItem(token,item);case 5:savedItem=_context2.sent;log('saveItem succeeded');dispatch({type:SAVE_ITEM_SUCCEEDED,payload:{item:savedItem}});_context2.next=14;break;case 10:_context2.prev=10;_context2.t0=_context2[\"catch\"](0);log('saveItem failed');dispatch({type:SAVE_ITEM_FAILED,payload:{error:_context2.t0}});case 14:case\"end\":return _context2.stop();}}},_callee2,null,[[0,10]]);}));return _saveItemCallback.apply(this,arguments);}function wsEffect(){var canceled=false;log('wsEffect - connecting');var closeWebSocket;if(token===null||token===void 0?void 0:token.trim()){closeWebSocket=newWebSocket(token,function(message){if(canceled){return;}var type=message.type,item=message.payload;log(\"ws message, item \".concat(type));if(type==='created'||type==='updated'){dispatch({type:SAVE_ITEM_SUCCEEDED,payload:{item:item}});}});}return function(){var _closeWebSocket;log('wsEffect - disconnecting');canceled=true;(_closeWebSocket=closeWebSocket)===null||_closeWebSocket===void 0?void 0:_closeWebSocket();};}};","map":{"version":3,"sources":["/Users/laura-elena.olaru/Downloads/FinalDocker/my-ionic-app/src/todo/ItemProvider.tsx"],"names":["React","useCallback","useContext","useEffect","useReducer","getLogger","createItem","getItems","newWebSocket","updateItem","AuthContext","log","initialState","fetching","saving","FETCH_ITEMS_STARTED","FETCH_ITEMS_SUCCEEDED","FETCH_ITEMS_FAILED","SAVE_ITEM_STARTED","SAVE_ITEM_SUCCEEDED","SAVE_ITEM_FAILED","reducer","state","type","payload","fetchingError","items","error","savingError","item","index","findIndex","it","_id","splice","ItemContext","createContext","ItemProvider","children","token","dispatch","getItemsEffect","wsEffect","saveItem","saveItemCallback","value","canceled","fetchItems","trim","savedItem","closeWebSocket","message"],"mappings":"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","sourcesContent":["import React, { useCallback, useContext, useEffect, useReducer } from 'react';\nimport PropTypes from 'prop-types';\nimport { getLogger } from '../core';\nimport { ItemProps } from './ItemProps';\nimport { createItem, getItems, newWebSocket, updateItem } from './itemApi';\nimport { AuthContext } from '../auth';\n\nconst log = getLogger('ItemProvider');\n\ntype SaveItemFn = (item: ItemProps) => Promise<any>;\n\nexport interface ItemsState {\n  items?: ItemProps[],\n  fetching: boolean,\n  fetchingError?: Error | null,\n  saving: boolean,\n  savingError?: Error | null,\n  saveItem?: SaveItemFn,\n}\n\ninterface ActionProps {\n  type: string,\n  payload?: any,\n}\n\nconst initialState: ItemsState = {\n  fetching: false,\n  saving: false,\n};\n\nconst FETCH_ITEMS_STARTED = 'FETCH_ITEMS_STARTED';\nconst FETCH_ITEMS_SUCCEEDED = 'FETCH_ITEMS_SUCCEEDED';\nconst FETCH_ITEMS_FAILED = 'FETCH_ITEMS_FAILED';\nconst SAVE_ITEM_STARTED = 'SAVE_ITEM_STARTED';\nconst SAVE_ITEM_SUCCEEDED = 'SAVE_ITEM_SUCCEEDED';\nconst SAVE_ITEM_FAILED = 'SAVE_ITEM_FAILED';\n\nconst reducer: (state: ItemsState, action: ActionProps) => ItemsState =\n  (state, { type, payload }) => {\n    switch (type) {\n      case FETCH_ITEMS_STARTED:\n        return { ...state, fetching: true, fetchingError: null };\n      case FETCH_ITEMS_SUCCEEDED:\n        return { ...state, items: payload.items, fetching: false };\n      case FETCH_ITEMS_FAILED:\n        return { ...state, fetchingError: payload.error, fetching: false };\n      case SAVE_ITEM_STARTED:\n        return { ...state, savingError: null, saving: true };\n      case SAVE_ITEM_SUCCEEDED:\n        const items = [...(state.items || [])];\n        const item = payload.item;\n        const index = items.findIndex(it => it._id === item._id);\n        if (index === -1) {\n          items.splice(0, 0, item);\n        } else {\n          items[index] = item;\n        }\n        return { ...state, items, saving: false };\n      case SAVE_ITEM_FAILED:\n        return { ...state, savingError: payload.error, saving: false };\n      default:\n        return state;\n    }\n  };\n\nexport const ItemContext = React.createContext<ItemsState>(initialState);\n\ninterface ItemProviderProps {\n  children: PropTypes.ReactNodeLike,\n}\n\nexport const ItemProvider: React.FC<ItemProviderProps> = ({ children }) => {\n  const { token } = useContext(AuthContext);\n  const [state, dispatch] = useReducer(reducer, initialState);\n  const { items, fetching, fetchingError, saving, savingError } = state;\n  useEffect(getItemsEffect, [token]);\n  useEffect(wsEffect, [token]);\n  const saveItem = useCallback<SaveItemFn>(saveItemCallback, [token]);\n  const value = { items, fetching, fetchingError, saving, savingError, saveItem };\n  log('returns');\n  return (\n    <ItemContext.Provider value={value}>\n      {children}\n    </ItemContext.Provider>\n  );\n\n  function getItemsEffect() {\n    let canceled = false;\n    fetchItems();\n    return () => {\n      canceled = true;\n    }\n\n    async function fetchItems() {\n      if (!token?.trim()) {\n        return;\n      }\n      try {\n        log('fetchItems started');\n        dispatch({ type: FETCH_ITEMS_STARTED });\n        const items = await getItems(token);\n        log('fetchItems succeeded');\n        if (!canceled) {\n          dispatch({ type: FETCH_ITEMS_SUCCEEDED, payload: { items } });\n        }\n      } catch (error) {\n        log('fetchItems failed');\n        dispatch({ type: FETCH_ITEMS_FAILED, payload: { error } });\n      }\n    }\n  }\n\n  async function saveItemCallback(item: ItemProps) {\n    try {\n      log('saveItem started');\n      dispatch({ type: SAVE_ITEM_STARTED });\n      const savedItem = await (item._id ? updateItem(token, item) : createItem(token, item));\n      log('saveItem succeeded');\n      dispatch({ type: SAVE_ITEM_SUCCEEDED, payload: { item: savedItem } });\n    } catch (error) {\n      log('saveItem failed');\n      dispatch({ type: SAVE_ITEM_FAILED, payload: { error } });\n    }\n  }\n\n  function wsEffect() {\n    let canceled = false;\n    log('wsEffect - connecting');\n    let closeWebSocket: () => void;\n    if (token?.trim()) {\n      closeWebSocket = newWebSocket(token, message => {\n        if (canceled) {\n          return;\n        }\n        const { type, payload: item } = message;\n        log(`ws message, item ${type}`);\n        if (type === 'created' || type === 'updated') {\n          dispatch({ type: SAVE_ITEM_SUCCEEDED, payload: { item } });\n        }\n      });\n    }\n    return () => {\n      log('wsEffect - disconnecting');\n      canceled = true;\n      closeWebSocket?.();\n    }\n  }\n};\n"]},"metadata":{},"sourceType":"module"}